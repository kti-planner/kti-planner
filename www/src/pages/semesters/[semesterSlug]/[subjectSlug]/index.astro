---
import { Classroom, makeClassroomData } from '@backend/classroom';
import { Exercise, makeExerciseData } from '@backend/exercise';
import { Semester } from '@backend/semester';
import { Subject } from '@backend/subject';
import { makeUserData, User } from '@backend/user';
import type { SemesterData } from '@components/semesters/types';
import type { SubjectData } from '@components/subjects/types';
import { formatDateLocalYyyyMmDd } from '@components/utils';
import Layout from '@layouts/Layout.astro';
import SubjectApp from '@components/subjects/SubjectApp.vue';

const { semesterSlug, subjectSlug } = Astro.params;
const { langId, user } = Astro.locals;

const translations = {
    'en': {
        'Semesters': 'Semesters',
        'Winter semester': 'Winter semester',
        'Summer semester': 'Summer semester',
    },
    'pl': {
        'Semesters': 'Semestry',
        'Winter semester': 'Semestr zimowy',
        'Summer semester': 'Semestr letni',
    },
};

function translate(text: keyof (typeof translations)[LangId]): string {
    return translations[langId][text];
}

if (semesterSlug === undefined || subjectSlug === undefined) {
    return new Response(null, { status: 404 });
}

const semester = await Semester.fetchBySlug(semesterSlug);
if (!semester) {
    return new Response(null, { status: 404 });
}

const semesterName = `${semester.type === 'summer' ? translate('Summer semester') : translate('Winter semester')} ${semester.year}/${semester.year + 1}`;

const subject = await Subject.fetchBySlug(semester, subjectSlug);
if (!subject) {
    return new Response(null, { status: 404 });
}

const semesterData: SemesterData = {
    id: semester.id,
    type: semester.type,
    year: semester.year,
    slug: semester.slug,
    startDate: formatDateLocalYyyyMmDd(semester.startDate),
    endDate: formatDateLocalYyyyMmDd(semester.endDate),
};

const subjectData: SubjectData = {
    id: subject.id,
    name: subject.name,
    semesterId: subject.semesterId,
    slug: subject.slug,
    teachers: (await subject.getTeachers()).map(makeUserData),
};

const allUsers = await User.fetchAll();
const allUsersData = allUsers.map(makeUserData);

const exercises = await Exercise.fetchAllFromSubject(subject);

const exercisesData = exercises.map(exercise => {
    const teacher = allUsers.find(user => user.id === exercise.teacherId);
    if (teacher === undefined) {
        throw new Error('Exercise teacher not found');
    }

    return makeExerciseData(exercise, teacher);
});

const nextExerciseNumber = exercises.reduce((max, e) => Math.max(max, e.exerciseNumber), 0) + 1;

const classrooms = await Classroom.fetchAll();
const classroomsData = classrooms.map(makeClassroomData);
---

<Layout
    breadcrumbs={[
        {
            text: translate('Semesters'),
            href: '/semesters/',
        },
        {
            text: semesterName,
            href: `/semesters/${semesterSlug}/`,
        },
        {
            text: subject.name,
            href: '#',
        },
    ]}
>
    <SubjectApp
        client:only="vue"
        subject={subjectData}
        semester={semesterData}
        isLoggedIn={user !== null}
        allUsers={allUsersData}
        exercises={exercisesData}
        classrooms={classroomsData}
        nextExerciseNumber={nextExerciseNumber}
    />
</Layout>
