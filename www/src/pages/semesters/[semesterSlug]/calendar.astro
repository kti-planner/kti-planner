---
import { Classroom, makeClassroomData } from '@backend/classroom';
import { makeScheduleChangeData, makeSemesterData, Semester } from '@backend/semester';
import { Subject } from '@backend/subject';
import { makeUserData, User } from '@backend/user';
import type { SubjectData } from '@components/subjects/types';
import Layout from '@layouts/Layout.astro';
import SemesterCalendar from '@components/semesters/SemesterCalendar.vue';

const { semesterSlug } = Astro.params;
const { langId } = Astro.locals;

const translations = {
    'en': {
        'Semesters': 'Semesters',
        'Winter semester': 'Winter semester',
        'Summer semester': 'Summer semester',
        'Calendar': 'Calendar',
    },
    'pl': {
        'Semesters': 'Semestry',
        'Winter semester': 'Semestr zimowy',
        'Summer semester': 'Semestr letni',
        'Calendar': 'Kalendarz',
    },
};

function translate(text: keyof (typeof translations)[LangId]): string {
    return translations[langId][text];
}

if (semesterSlug === undefined) {
    return new Response(null, { status: 404 });
}

const semester = await Semester.fetchBySlug(semesterSlug);
if (!semester) {
    return new Response(null, { status: 404 });
}

const semesterName = `${semester.type === 'summer' ? translate('Summer semester') : translate('Winter semester')} ${semester.year}/${semester.year + 1}`;
const semesterData = makeSemesterData(semester);

const scheduleChanges = await semester.getScheduleChanges();
const scheduleChangesData = scheduleChanges.map(makeScheduleChangeData);

const users = await User.fetchAll();
const subjects = await Subject.fetchAllFromSemester(semester);

const subjectsData = subjects.map<SubjectData>(subject => {
    const teachers = users.filter(user => subject.teacherIds.includes(user.id));

    return {
        id: subject.id,
        name: subject.name,
        semesterId: subject.semesterId,
        slug: subject.slug,
        teachers: teachers.map(makeUserData),
    };
});

const classrooms = await Classroom.fetchAll();
const classroomsData = classrooms.map(makeClassroomData);
---

<Layout
    breadcrumbs={[
        {
            text: translate('Semesters'),
            href: '/semesters/',
        },
        {
            text: semesterName,
            href: `/semesters/${semesterSlug}/`,
        },
        {
            text: translate('Calendar'),
            href: '#',
        },
    ]}
>
    <SemesterCalendar
        client:only="vue"
        semester={semesterData}
        scheduleChanges={scheduleChangesData}
        subjects={subjectsData}
        classrooms={classroomsData}
    />
</Layout>
